version: '2'

services:
  ca-tju:
    container_name: ca_tju
    image: hyperledger/fabric-ca
    environment:
      - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
    ports:
      - "7054:7054"
    command: sh -c 'fabric-ca-server start -c /etc/hyperledger/fabric-ca-config/fabric-ca-client-config.yaml -b admin:adminpw -d'
    volumes:
      - ./ca/:/etc/hyperledger/fabric-ca-config

  orderer:
    container_name: orderer
    image: hyperledger/fabric-orderer
    environment:
      - ORDERER_GENERAL_TLS_ENABLED=false
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/orderer
    command: orderer
    ports:
      - "7050:7050"
    volumes:
      - ./channel/:/etc/hyperledger/configtx
      - ./orderer/:/etc/hyperledger/fabric-orderer-config

  peer-tju:
    container_name: peer-tju
    image: hyperledger/fabric-peer
    environment:
      - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
      - CORE_PEER_ID=peer-tju
      - CORE_PEER_ENDORSER_ENABLED=true
      - CORE_PEER_LOCALMSPID=tjumsp
      - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp/peer/
      - CORE_PEER_GOSSIP_ORGLEADER=true
      - CORE_PEER_GOSSIP_SKIPHANDSHAKE=true
      - CORE_PEER_ADDRESS=peer0:7051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer-tju:7051
      - CORE_PEER_TLS_ENABLED=false

      # the following setting starts chaincode containers on the same
      # bridge network as the peers
      # note: Docker changes the project name to lowercase and throws out special characters
      # https://docs.docker.com/compose/networking/
      - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=hf_demo_default
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric
    command: peer node start --peer-defaultchain=false
    ports:
      - 7051:7051
      - 7053:7053
    volumes:
      - /var/run/:/host/var/run/
      - ./peer/peer-tju/:/etc/hyperledger/msp/peer
    depends_on:
      - orderer

  peer-company-a:
      container_name: peer-company-a
      image: hyperledger/fabric-peer
      environment:
        - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock
        - CORE_PEER_ID=peer-company-a
        - CORE_PEER_ENDORSER_ENABLED=true
        - CORE_PEER_LOCALMSPID=companyamsp
        - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/msp/peer/
        - CORE_PEER_GOSSIP_ORGLEADER=true
        - CORE_PEER_GOSSIP_SKIPHANDSHAKE=true
        - CORE_PEER_ADDRESS=peer-company-a:7051
        - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer-company-a:7051
        - CORE_PEER_TLS_ENABLED=false

        # the following setting starts chaincode containers on the same
        # bridge network as the peers
        # note: Docker changes the project name to lowercase and throws out special characters
        # https://docs.docker.com/compose/networking/
        - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=hf_demo_default
      working_dir: /opt/gopath/src/github.com/hyperledger/fabric
      command: peer node start --peer-defaultchain=false
      ports:
        - 8051:7051
        - 8053:7053
      volumes:
        - /var/run/:/host/var/run/
        - ./peer/peer-company-a/:/etc/hyperledger/msp/peer
      depends_on:
        - orderer
